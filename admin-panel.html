<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Free Fire Tournament</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: Arial, sans-serif;
        }
        
        body {
            background: #0a0a0a;
            color: white;
            min-height: 100vh;
        }
        
        .admin-header {
            background: #111;
            padding: 20px;
            border-bottom: 2px solid #ffaa00;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .admin-header h1 {
            color: #ffaa00;
            font-size: 24px;
        }
        
        .header-actions {
            display: flex;
            gap: 15px;
            align-items: center;
        }
        
        .btn-logout {
            background: #ff4655;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
        }
        
        .btn-back {
            background: #00f0ff;
            color: black;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            text-decoration: none;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: rgba(20, 20, 30, 0.9);
            border: 1px solid #333;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
        }
        
        .stat-card h3 {
            color: #00f0ff;
            margin-bottom: 10px;
            font-size: 14px;
        }
        
        .stat-card .value {
            color: white;
            font-size: 32px;
            font-weight: bold;
        }
        
        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 2px solid #333;
            flex-wrap: wrap;
        }
        
        .tab-btn {
            padding: 15px 25px;
            background: none;
            border: none;
            color: #888;
            font-size: 16px;
            cursor: pointer;
            white-space: nowrap;
        }
        
        .tab-btn.active {
            color: #ffaa00;
            border-bottom: 3px solid #ffaa00;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .requests-container {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
        }
        
        .request-card {
            background: rgba(20, 20, 30, 0.9);
            border: 1px solid #333;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .request-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid #333;
        }
        
        .request-header h3 {
            color: #ffaa00;
        }
        
        .request-status {
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
        }
        
        .status-pending {
            background: rgba(255, 170, 0, 0.2);
            color: #ffaa00;
            border: 1px solid #ffaa00;
        }
        
        .request-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        @media (max-width: 768px) {
            .request-details {
                grid-template-columns: 1fr;
            }
        }
        
        .detail-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .detail-label {
            color: #aaa;
        }
        
        .detail-value {
            color: white;
            font-weight: bold;
        }
        
        .screenshot-section {
            margin: 20px 0;
            text-align: center;
        }
        
        .screenshot-label {
            color: #00f0ff;
            margin-bottom: 10px;
            font-weight: bold;
        }
        
        .screenshot-image {
            max-width: 100%;
            max-height: 300px;
            border-radius: 10px;
            border: 2px solid #333;
            cursor: pointer;
        }
        
        .request-actions {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }
        
        .btn-approve {
            background: #00ff88;
            color: black;
            border: none;
            padding: 12px 25px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            flex: 1;
        }
        
        .btn-reject {
            background: #ff4655;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            flex: 1;
        }
        
        .withdrawal-method {
            display: inline-block;
            background: rgba(0, 240, 255, 0.2);
            color: #00f0ff;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 14px;
            margin-top: 5px;
        }
        
        .empty-state {
            text-align: center;
            padding: 50px;
            color: #aaa;
        }
        
        .message {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
            display: none;
        }
        
        .message.success {
            background: rgba(0, 255, 136, 0.1);
            color: #00ff88;
            border: 1px solid #00ff88;
            display: block;
        }
        
        .message.error {
            background: rgba(255, 70, 85, 0.1);
            color: #ff4655;
            border: 1px solid #ff4655;
            display: block;
        }
        
        .tournament-form {
            background: rgba(20, 20, 30, 0.9);
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 30px;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #00f0ff;
        }
        
        .form-group input, .form-group textarea, .form-group select {
            width: 100%;
            padding: 12px;
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid #333;
            border-radius: 5px;
            color: white;
        }
        
        .btn-create {
            background: #ffaa00;
            color: black;
            border: none;
            padding: 15px 30px;
            border-radius: 5px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            width: 100%;
        }
        
        .settings-form {
            background: rgba(20, 20, 30, 0.9);
            padding: 25px;
            border-radius: 10px;
        }
        
        .settings-section {
            margin-bottom: 30px;
            padding-bottom: 30px;
            border-bottom: 1px solid #333;
        }
        
        .btn-save {
            background: #00ff88;
            color: black;
            border: none;
            padding: 12px 25px;
            border-radius: 5px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 10px;
        }
        
        .support-info {
            background: rgba(37, 211, 102, 0.1);
            border: 1px solid #25D366;
            border-radius: 10px;
            padding: 20px;
            margin-top: 30px;
        }
        
        .screenshot-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .screenshot-modal img {
            max-width: 90%;
            max-height: 90%;
            border-radius: 10px;
        }
        
        .close-modal {
            position: absolute;
            top: 20px;
            right: 20px;
            background: #ff4655;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 20px;
        }
        
        /* FIREBASE STYLES ADDED */
        .firebase-status {
            background: rgba(0, 240, 255, 0.1);
            padding: 10px;
            border-radius: 5px;
            margin: 10px 20px;
            text-align: center;
            font-size: 14px;
            color: #00f0ff;
        }
        
        .firebase-status.connected {
            background: rgba(0, 255, 136, 0.1);
            color: #00ff88;
        }
        
        .firebase-status.disconnected {
            background: rgba(255, 70, 85, 0.1);
            color: #ff4655;
        }
        
        .sync-buttons {
            display: flex;
            gap: 10px;
            margin: 10px 20px;
        }
        
        .btn-sync {
            background: #00f0ff;
            color: black;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            font-size: 12px;
        }
        
        .btn-sync:hover {
            background: #00ccff;
        }
        
        .firebase-badge {
            background: #ff6b00;
            color: white;
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 11px;
            margin-left: 5px;
        }
        
        /* TOURNAMENT LIST STYLES */
        .tournaments-list {
            margin-top: 30px;
        }
        
        .tournament-card {
            background: rgba(20, 20, 30, 0.9);
            border: 1px solid #333;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .tournament-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .tournament-name {
            color: #ffaa00;
            font-size: 20px;
        }
        
        .tournament-status {
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .status-active {
            background: rgba(0, 255, 136, 0.2);
            color: #00ff88;
            border: 1px solid #00ff88;
        }
        
        .tournament-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .tournament-detail {
            text-align: center;
        }
        
        .detail-title {
            color: #aaa;
            font-size: 12px;
            margin-bottom: 5px;
        }
        
        .detail-value {
            color: white;
            font-weight: bold;
            font-size: 16px;
        }
        
        .tournament-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .btn-action {
            padding: 8px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .btn-edit {
            background: #00f0ff;
            color: black;
        }
        
        .btn-delete {
            background: #ff4655;
            color: white;
        }
        
        .btn-view {
            background: #ffaa00;
            color: black;
        }
        
        /* AUTO-FEATURE NOTIFICATION STYLES */
        .auto-notification {
            position: fixed;
            top: 80px;
            right: 20px;
            background: #00ff88;
            color: black;
            padding: 15px 25px;
            border-radius: 10px;
            z-index: 10000;
            font-weight: bold;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            display: flex;
            align-items: center;
            gap: 10px;
            animation: slideInRight 0.3s ease;
            max-width: 400px;
        }
        
        .auto-notification.error {
            background: #ff4655;
            color: white;
        }
        
        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        @keyframes slideOutRight {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- FIREBASE SDK ADDED -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
</head>
<body>
    <!-- Admin Header -->
    <div class="admin-header">
        <h1><i class="fas fa-user-shield"></i> ADMIN PANEL</h1>
        <div class="header-actions">
            <a href="dashboard.html" class="btn-back"><i class="fas fa-home"></i> User Panel</a>
            <button class="btn-logout" onclick="logoutAdmin()"><i class="fas fa-sign-out-alt"></i> Logout</button>
        </div>
    </div>

    <!-- Firebase Status Display -->
    <div class="firebase-status" id="firebaseStatus">
        <i class="fas fa-database"></i> 
        <span id="statusText">Connecting to database...</span>
    </div>
    
    <!-- Sync Buttons -->
    <div class="sync-buttons">
        <button class="btn-sync" onclick="syncFromFirebase()">
            <i class="fas fa-download"></i> Sync from Firebase
        </button>
        <button class="btn-sync" onclick="syncToFirebase()">
            <i class="fas fa-upload"></i> Sync to Firebase
        </button>
        <button class="btn-sync" onclick="loadDepositRequests()">
            <i class="fas fa-sync-alt"></i> Refresh Now
        </button>
    </div>

    <div class="container">
        <!-- Message -->
        <div class="message" id="message"></div>
        
        <!-- Stats -->
        <div class="stats-grid">
            <div class="stat-card">
                <h3>Total Users</h3>
                <div class="value" id="totalUsers">0</div>
            </div>
            
            <div class="stat-card">
                <h3>Pending Deposits</h3>
                <div class="value" id="pendingDeposits">0</div>
            </div>
            
            <div class="stat-card">
                <h3>Pending Withdrawals</h3>
                <div class="value" id="pendingWithdrawals">0</div>
            </div>
            
            <div class="stat-card">
                <h3>Active Tournaments</h3>
                <div class="value" id="activeTournaments">0</div>
            </div>
        </div>
        
        <!-- Tabs -->
        <div class="tabs">
            <button class="tab-btn active" onclick="showTab('deposits')">Deposit Requests <span id="firebaseDepositBadge" class="firebase-badge" style="display: none;">ðŸ”¥</span></button>
            <button class="tab-btn" onclick="showTab('withdrawals')">Withdrawal Requests <span id="firebaseWithdrawalBadge" class="firebase-badge" style="display: none;">ðŸ”¥</span></button>
            <button class="tab-btn" onclick="showTab('tournament')">Tournament Management</button>
            <button class="tab-btn" onclick="showTab('users')">User Management</button>
            <button class="tab-btn" onclick="showTab('settings')">Admin Settings</button>
        </div>
        
        <!-- Deposit Requests Tab -->
        <div id="depositsTab" class="tab-content active">
            <h2 style="color: #ffaa00; margin-bottom: 20px;">Deposit Requests <small style="color: #00f0ff; font-size: 14px;" id="depositSource">(Loading...)</small></h2>
            
            <div class="requests-container" id="depositRequests">
                <!-- Deposit requests will be loaded here -->
            </div>
        </div>
        
        <!-- Withdrawal Requests Tab -->
        <div id="withdrawalsTab" class="tab-content">
            <h2 style="color: #ffaa00; margin-bottom: 20px;">Withdrawal Requests <small style="color: #00f0ff; font-size: 14px;" id="withdrawalSource">(Loading...)</small></h2>
            
            <div class="requests-container" id="withdrawalRequests">
                <!-- Withdrawal requests will be loaded here -->
            </div>
        </div>
        
        <!-- Tournament Management Tab -->
        <div id="tournamentTab" class="tab-content">
            <h2 style="color: #ffaa00; margin-bottom: 20px;">Tournament Management</h2>
            
            <div class="tournament-form">
                <h3 style="color: #00f0ff; margin-bottom: 20px;">Create New Tournament</h3>
                
                <form id="tournamentForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Tournament Name</label>
                            <input type="text" id="tournamentName" placeholder="Free Fire Championship" required>
                        </div>
                        
                        <div class="form-group">
                            <label>Entry Fee (PKR)</label>
                            <input type="number" id="entryFee" placeholder="100" min="0" required>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Prize Pool (PKR)</label>
                            <input type="number" id="prizePool" placeholder="50000" min="0" required>
                        </div>
                        
                        <div class="form-group">
                            <label>Max Players</label>
                            <input type="number" id="maxPlayers" placeholder="100" min="1" required>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Description</label>
                        <textarea id="tournamentDesc" placeholder="Describe the tournament"></textarea>
                    </div>
                    
                    <button type="submit" class="btn-create">
                        <i class="fas fa-plus-circle"></i> CREATE TOURNAMENT
                    </button>
                </form>
            </div>
            
            <!-- Tournament List -->
            <div class="tournaments-list">
                <h3 style="color: #00f0ff; margin-bottom: 20px;">Active Tournaments</h3>
                <div id="tournamentsList">
                    <!-- Tournaments will be loaded here -->
                </div>
            </div>
        </div>
        
        <!-- User Management Tab -->
        <div id="usersTab" class="tab-content">
            <h2 style="color: #ffaa00; margin-bottom: 20px;">User Management</h2>
            
            <div style="overflow-x: auto; margin-bottom: 20px;">
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr>
                            <th style="background: rgba(255, 170, 0, 0.2); color: #ffaa00; padding: 15px; text-align: left;">Username</th>
                            <th style="background: rgba(255, 170, 0, 0.2); color: #ffaa00; padding: 15px; text-align: left;">FF ID</th>
                            <th style="background: rgba(255, 170, 0, 0.2); color: #ffaa00; padding: 15px; text-align: left;">Phone</th>
                            <th style="background: rgba(255, 170, 0, 0.2); color: #ffaa00; padding: 15px; text-align: left;">Balance</th>
                            <th style="background: rgba(255, 170, 0, 0.2); color: #ffaa00; padding: 15px; text-align: left;">Status</th>
                            <th style="background: rgba(255, 170, 0, 0.2); color: #ffaa00; padding: 15px; text-align: left;">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="usersTable">
                        <!-- Users will be loaded here -->
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- Admin Settings Tab -->
        <div id="settingsTab" class="tab-content">
            <h2 style="color: #ffaa00; margin-bottom: 20px;">Admin Settings</h2>
            
            <div class="settings-form">
                <div class="settings-section">
                    <h3><i class="fas fa-key"></i> Change Admin Password</h3>
                    <div class="form-group">
                        <label>Current Password</label>
                        <input type="password" id="currentPassword" placeholder="Enter current password">
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>New Password</label>
                            <input type="password" id="newPassword" placeholder="Enter new password">
                        </div>
                        
                        <div class="form-group">
                            <label>Confirm New Password</label>
                            <input type="password" id="confirmPassword" placeholder="Confirm new password">
                        </div>
                    </div>
                    
                    <button class="btn-save" onclick="changePassword()">
                        <i class="fas fa-save"></i> Update Password
                    </button>
                </div>
                
                <div class="settings-section">
                    <h3><i class="fas fa-database"></i> Database Management</h3>
                    <div class="sync-buttons" style="margin: 0;">
                        <button class="btn-sync" onclick="exportDatabase()">
                            <i class="fas fa-download"></i> Export Database
                        </button>
                        <button class="btn-sync" onclick="importDatabase()">
                            <i class="fas fa-upload"></i> Import Database
                        </button>
                        <button class="btn-sync" onclick="clearDatabase()" style="background: #ff4655;">
                            <i class="fas fa-trash"></i> Clear All Data
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Screenshot Modal -->
    <div class="screenshot-modal" id="screenshotModal">
        <button class="close-modal" onclick="closeScreenshot()">&times;</button>
        <img id="fullScreenshot" src="" alt="Transaction Screenshot">
    </div>

    <script>
        // ====== FIREBASE CONFIGURATION ======
        const firebaseConfig = {
            apiKey: "AIzaSyD67JoFIKJBGTPLeTyP_5ujlzUrdrjg1mU",
            authDomain: "freefiretournament-ca6b8.firebaseapp.com",
            databaseURL: "https://freefiretournament-ca6b8-default-rtdb.firebaseio.com",
            projectId: "freefiretournament-ca6b8",
            storageBucket: "freefiretournament-ca6b8.firebasestorage.app",
            messagingSenderId: "300616210510",
            appId: "1:300616210510:web:48a9b2479dedfc07948b1f",
            measurementId: "G-EG656MC9SF"
        };
        
        let db = null; // Firebase database
        let firebaseConnected = false;
        
        // ====== CHECK ADMIN AUTHENTICATION ======
        if (localStorage.getItem('adminLoggedIn') !== 'true') {
            window.location.href = 'admin-login.html';
        }

        // ====== INITIALIZE FIREBASE AND LOAD DATA ======
        window.addEventListener('load', function() {
            initializeFirebase();
            loadDepositRequests();
            loadWithdrawalRequests();
            loadUsers();
            loadTournaments();
        });

        // ====== FIREBASE INITIALIZATION ======
        function initializeFirebase() {
            try {
                firebase.initializeApp(firebaseConfig);
                db = firebase.firestore();
                firebaseConnected = true;
                
                document.getElementById('statusText').textContent = 'âœ… Connected to Firebase - Real-time updates active';
                document.getElementById('firebaseStatus').className = 'firebase-status connected';
                
                console.log('Firebase connected successfully!');
                
                // Set up real-time listeners
                setupRealtimeDeposits();
                setupRealtimeWithdrawals();
                
                // Auto-refresh
                setInterval(loadDepositRequests, 30000);
                setInterval(loadWithdrawalRequests, 30000);
                
            } catch (error) {
                console.error('Firebase initialization error:', error);
                firebaseConnected = false;
                document.getElementById('statusText').textContent = 'âš ï¸ Firebase offline - Using local storage only';
                document.getElementById('firebaseStatus').className = 'firebase-status disconnected';
                document.getElementById('depositSource').textContent = '(Local Storage)';
            }
        }

        // ====== FIREBASE FUNCTIONS ======
        function setupRealtimeDeposits() {
            if (!db) return;
            
            db.collection('deposits')
                .where('status', '==', 'pending')
                .onSnapshot((snapshot) => {
                    console.log('ðŸ”¥ Real-time deposit update received!');
                    document.getElementById('firebaseDepositBadge').style.display = 'inline';
                    setTimeout(() => {
                        document.getElementById('firebaseDepositBadge').style.display = 'none';
                    }, 2000);
                    loadDepositRequests();
                });
        }
        
        function setupRealtimeWithdrawals() {
            if (!db) return;
            
            db.collection('withdrawals')
                .where('status', '==', 'pending')
                .onSnapshot((snapshot) => {
                    console.log('ðŸ”¥ Real-time withdrawal update received!');
                    document.getElementById('firebaseWithdrawalBadge').style.display = 'inline';
                    setTimeout(() => {
                        document.getElementById('firebaseWithdrawalBadge').style.display = 'none';
                    }, 2000);
                    loadWithdrawalRequests();
                });
        }
        
        async function syncFromFirebase() {
            if (!firebaseConnected) {
                showMessage('Firebase not connected. Check your internet.', 'error');
                return;
            }
            
            try {
                // Get deposits from Firebase
                const snapshot = await db.collection('deposits')
                    .where('status', '==', 'pending')
                    .orderBy('timestamp', 'desc')
                    .get();
                
                let firebaseDeposits = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    data.firebaseId = doc.id;
                    data.id = data.id || data.firebaseId; // Ensure ID exists
                    firebaseDeposits.push(data);
                });
                
                // Get withdrawals from Firebase
                const withdrawalSnapshot = await db.collection('withdrawals')
                    .where('status', '==', 'pending')
                    .orderBy('timestamp', 'desc')
                    .get();
                
                let firebaseWithdrawals = [];
                withdrawalSnapshot.forEach(doc => {
                    const data = doc.data();
                    data.firebaseId = doc.id;
                    data.id = data.id || data.firebaseId; // Ensure ID exists
                    firebaseWithdrawals.push(data);
                });
                
                // Merge with local storage
                mergeWithLocalStorage(firebaseDeposits, firebaseWithdrawals);
                
                showMessage(`Synced ${firebaseDeposits.length} deposits and ${firebaseWithdrawals.length} withdrawals from Firebase`, 'success');
                loadDepositRequests();
                loadWithdrawalRequests();
                
            } catch (error) {
                console.error('Sync error:', error);
                showMessage('Error syncing from Firebase', 'error');
            }
        }
        
        async function syncToFirebase() {
            if (!firebaseConnected) {
                showMessage('Firebase not connected. Check your internet.', 'error');
                return;
            }
            
            try {
                // Get local deposits
                const localDeposits = JSON.parse(localStorage.getItem('depositRequests')) || [];
                const pendingDeposits = localDeposits.filter(d => d.status === 'pending');
                
                // Get local withdrawals
                const localWithdrawals = JSON.parse(localStorage.getItem('withdrawalRequests')) || [];
                const pendingWithdrawals = localWithdrawals.filter(w => w.status === 'pending');
                
                let uploadedCount = 0;
                
                // Upload deposits to Firebase
                for (const deposit of pendingDeposits) {
                    if (!deposit.firebaseId) {
                        await db.collection('deposits').add(deposit);
                        uploadedCount++;
                    }
                }
                
                // Upload withdrawals to Firebase
                for (const withdrawal of pendingWithdrawals) {
                    if (!withdrawal.firebaseId) {
                        await db.collection('withdrawals').add(withdrawal);
                        uploadedCount++;
                    }
                }
                
                showMessage(`Uploaded ${uploadedCount} requests to Firebase`, 'success');
                
            } catch (error) {
                console.error('Upload error:', error);
                showMessage('Error uploading to Firebase', 'error');
            }
        }
        
        function mergeWithLocalStorage(firebaseDeposits, firebaseWithdrawals) {
            // Merge deposits
            let localDeposits = JSON.parse(localStorage.getItem('depositRequests')) || [];
            
            firebaseDeposits.forEach(fbDeposit => {
                const exists = localDeposits.some(localDeposit => 
                    localDeposit.firebaseId === fbDeposit.firebaseId || 
                    localDeposit.id === fbDeposit.id
                );
                
                if (!exists) {
                    localDeposits.push(fbDeposit);
                }
            });
            
            localStorage.setItem('depositRequests', JSON.stringify(localDeposits));
            
            // Merge withdrawals
            let localWithdrawals = JSON.parse(localStorage.getItem('withdrawalRequests')) || [];
            
            firebaseWithdrawals.forEach(fbWithdrawal => {
                const exists = localWithdrawals.some(localWithdrawal => 
                    localWithdrawal.firebaseId === fbWithdrawal.firebaseId || 
                    localWithdrawal.id === fbWithdrawal.id
                );
                
                if (!exists) {
                    localWithdrawals.push(fbWithdrawal);
                }
            });
            
            localStorage.setItem('withdrawalRequests', JSON.stringify(localWithdrawals));
        }

        // ====== TAB SWITCHING FUNCTION ======
        function showTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(tabName + 'Tab').classList.add('active');
            
            // Update tab buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Load data for selected tab
            if (tabName === 'deposits') {
                loadDepositRequests();
            } else if (tabName === 'withdrawals') {
                loadWithdrawalRequests();
            } else if (tabName === 'users') {
                loadUsers();
            } else if (tabName === 'tournament') {
                loadTournaments();
            }
        }

        // ====== LOGOUT ADMIN ======
        function logoutAdmin() {
            localStorage.removeItem('adminLoggedIn');
            window.location.href = 'admin-login.html';
        }

        // ====== LOAD DEPOSIT REQUESTS (FIXED FOR FIREBASE) ======
        async function loadDepositRequests() {
            let depositRequests = [];
            let source = 'Local Storage';
            
            if (firebaseConnected) {
                try {
                    // Get from Firebase
                    const snapshot = await db.collection('deposits')
                        .where('status', '==', 'pending')
                        .orderBy('timestamp', 'desc')
                        .get();
                    
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        data.firebaseId = doc.id; // Firebase document ID
                        data.id = data.id || data.firebaseId; // Use Firebase ID if no local ID
                        depositRequests.push(data);
                    });
                    
                    source = 'Firebase ðŸ”¥';
                    
                } catch (error) {
                    console.error('Firebase error:', error);
                    source = 'Local Storage (Fallback)';
                    depositRequests = JSON.parse(localStorage.getItem('depositRequests')) || [];
                }
            } else {
                depositRequests = JSON.parse(localStorage.getItem('depositRequests')) || [];
            }
            
            document.getElementById('depositSource').textContent = `(${source})`;
            
            const depositContainer = document.getElementById('depositRequests');
            depositContainer.innerHTML = '';
            
            if (depositRequests.length === 0) {
                depositContainer.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-money-bill-wave" style="font-size: 48px; margin-bottom: 20px;"></i>
                        <h3>No deposit requests yet</h3>
                        <p>When users make deposits, they will appear here</p>
                        <small style="color: #00f0ff;">Source: ${source}</small>
                    </div>
                `;
                document.getElementById('pendingDeposits').textContent = '0';
                return;
            }
            
            document.getElementById('pendingDeposits').textContent = depositRequests.length;
            
            depositRequests.forEach((deposit, index) => {
                const requestCard = document.createElement('div');
                requestCard.className = 'request-card';
                
                const isFirebase = deposit.firebaseId || false;
                const firebaseBadge = isFirebase ? '<span class="firebase-badge">ðŸ”¥</span>' : '';
                
                // FIX: Use the correct ID for Firebase requests
                const depositId = isFirebase ? deposit.firebaseId : deposit.id;
                const username = deposit.username || 'Unknown';
                const amount = deposit.amount || 0;
                
                requestCard.innerHTML = `
                    <div class="request-header">
                        <h3>Deposit Request #${index + 1} ${firebaseBadge}</h3>
                        <span class="request-status status-pending">PENDING</span>
                    </div>
                    
                    <div class="request-details">
                        <div class="detail-item">
                            <span class="detail-label">Username:</span>
                            <span class="detail-value">${username}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Player ID:</span>
                            <span class="detail-value">${deposit.playerId || 'N/A'}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Amount:</span>
                            <span class="detail-value" style="color: #00ff88;">PKR ${amount}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Date:</span>
                            <span class="detail-value">${new Date(deposit.date || deposit.timestamp || Date.now()).toLocaleString()}</span>
                        </div>
                    </div>
                    
                    ${deposit.screenshot ? `
                    <div class="screenshot-section">
                        <div class="screenshot-label">Transaction Screenshot:</div>
                        <img src="${deposit.screenshot}" 
                             alt="Transaction Proof" 
                             class="screenshot-image"
                             onclick="viewScreenshot('${deposit.screenshot}')">
                    </div>
                    ` : ''}
                    
                    <div class="request-actions">
                        <button class="btn-approve" onclick="approveDeposit('${depositId}', '${username}', ${amount}, ${isFirebase})">
                            <i class="fas fa-check"></i> APPROVE DEPOSIT
                        </button>
                        <button class="btn-reject" onclick="rejectDeposit('${depositId}', ${isFirebase})">
                            <i class="fas fa-times"></i> REJECT DEPOSIT
                        </button>
                    </div>
                `;
                depositContainer.appendChild(requestCard);
            });
        }

        // ====== LOAD WITHDRAWAL REQUESTS (FIXED FOR FIREBASE) ======
        async function loadWithdrawalRequests() {
            let withdrawalRequests = [];
            let source = 'Local Storage';
            
            if (firebaseConnected) {
                try {
                    // Get from Firebase
                    const snapshot = await db.collection('withdrawals')
                        .where('status', '==', 'pending')
                        .orderBy('timestamp', 'desc')
                        .get();
                    
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        data.firebaseId = doc.id; // Firebase document ID
                        data.id = data.id || data.firebaseId; // Use Firebase ID if no local ID
                        withdrawalRequests.push(data);
                    });
                    
                    source = 'Firebase ðŸ”¥';
                    
                } catch (error) {
                    console.error('Firebase error:', error);
                    source = 'Local Storage (Fallback)';
                    withdrawalRequests = JSON.parse(localStorage.getItem('withdrawalRequests')) || [];
                }
            } else {
                withdrawalRequests = JSON.parse(localStorage.getItem('withdrawalRequests')) || [];
            }
            
            document.getElementById('withdrawalSource').textContent = `(${source})`;
            
            const withdrawalContainer = document.getElementById('withdrawalRequests');
            withdrawalContainer.innerHTML = '';
            
            if (withdrawalRequests.length === 0) {
                withdrawalContainer.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-university" style="font-size: 48px; margin-bottom: 20px;"></i>
                        <h3>No withdrawal requests yet</h3>
                        <p>When users request withdrawals, they will appear here</p>
                        <small style="color: #00f0ff;">Source: ${source}</small>
                    </div>
                `;
                document.getElementById('pendingWithdrawals').textContent = '0';
                return;
            }
            
            document.getElementById('pendingWithdrawals').textContent = withdrawalRequests.length;
            
            withdrawalRequests.forEach((withdraw, index) => {
                const requestCard = document.createElement('div');
                requestCard.className = 'request-card';
                
                const isFirebase = withdraw.firebaseId || false;
                const firebaseBadge = isFirebase ? '<span class="firebase-badge">ðŸ”¥</span>' : '';
                
                // FIX: Use the correct ID for Firebase requests
                const withdrawalId = isFirebase ? withdraw.firebaseId : withdraw.id;
                
                requestCard.innerHTML = `
                    <div class="request-header">
                        <h3>Withdrawal Request #${index + 1} ${firebaseBadge}</h3>
                        <span class="request-status status-pending">PENDING</span>
                    </div>
                    
                    <div class="request-details">
                        <div class="detail-item">
                            <span class="detail-label">Username:</span>
                            <span class="detail-value">${withdraw.username}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Payment Method:</span>
                            <span class="detail-value">
                                ${withdraw.method === 'easypaisa' ? 'EasyPaisa' : 'JazzCash'}
                                <span class="withdrawal-method">${withdraw.method ? withdraw.method.toUpperCase() : 'N/A'}</span>
                            </span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Account Name:</span>
                            <span class="detail-value">${withdraw.accountName || 'N/A'}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Account Number:</span>
                            <span class="detail-value">${withdraw.accountNumber || 'N/A'}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Amount:</span>
                            <span class="detail-value" style="color: #ffaa00;">PKR ${withdraw.amount}</span>
                        </div>
                    </div>
                    
                    <div class="request-actions">
                        <button class="btn-approve" onclick="approveWithdrawal('${withdrawalId}', ${isFirebase})">
                            <i class="fas fa-check"></i> APPROVE WITHDRAWAL
                        </button>
                        <button class="btn-reject" onclick="rejectWithdrawal('${withdrawalId}', ${isFirebase})">
                            <i class="fas fa-times"></i> REJECT WITHDRAWAL
                        </button>
                    </div>
                `;
                withdrawalContainer.appendChild(requestCard);
            });
        }

        // ====== LOAD TOURNAMENTS ======
        function loadTournaments() {
            const tournaments = JSON.parse(localStorage.getItem('tournaments')) || [];
            const tournamentsList = document.getElementById('tournamentsList');
            
            tournamentsList.innerHTML = '';
            
            if (tournaments.length === 0) {
                tournamentsList.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-trophy" style="font-size: 48px; margin-bottom: 20px;"></i>
                        <h3>No tournaments created yet</h3>
                        <p>Create your first tournament using the form above</p>
                    </div>
                `;
                document.getElementById('activeTournaments').textContent = '0';
                return;
            }
            
            const activeTournaments = tournaments.filter(t => t.status === 'active');
            document.getElementById('activeTournaments').textContent = activeTournaments.length;
            
            activeTournaments.forEach((tournament, index) => {
                const tournamentCard = document.createElement('div');
                tournamentCard.className = 'tournament-card';
                
                tournamentCard.innerHTML = `
                    <div class="tournament-header">
                        <h3 class="tournament-name">${tournament.name}</h3>
                        <span class="tournament-status status-active">ACTIVE</span>
                    </div>
                    
                    <div class="tournament-details">
                        <div class="tournament-detail">
                            <div class="detail-title">Entry Fee</div>
                            <div class="detail-value" style="color: #ffaa00;">PKR ${tournament.entryFee}</div>
                        </div>
                        <div class="tournament-detail">
                            <div class="detail-title">Prize Pool</div>
                            <div class="detail-value" style="color: #00ff88;">PKR ${tournament.prizePool}</div>
                        </div>
                        <div class="tournament-detail">
                            <div class="detail-title">Max Players</div>
                            <div class="detail-value">${tournament.maxPlayers}</div>
                        </div>
                        <div class="tournament-detail">
                            <div class="detail-title">Created</div>
                            <div class="detail-value">${new Date(tournament.createdAt).toLocaleDateString()}</div>
                        </div>
                    </div>
                    
                    ${tournament.description ? `
                    <div style="margin: 15px 0; color: #aaa;">
                        <strong>Description:</strong> ${tournament.description}
                    </div>
                    ` : ''}
                    
                    <div class="tournament-actions">
                        <button class="btn-action btn-edit" onclick="editTournament(${index})">
                            <i class="fas fa-edit"></i> Edit
                        </button>
                        <button class="btn-action btn-delete" onclick="deleteTournament(${index})">
                            <i class="fas fa-trash"></i> Delete
                        </button>
                        <button class="btn-action btn-view" onclick="viewTournamentPlayers(${index})">
                            <i class="fas fa-users"></i> View Players
                        </button>
                    </div>
                `;
                tournamentsList.appendChild(tournamentCard);
            });
        }

        // ====== LOAD USERS ======
        function loadUsers() {
            const users = JSON.parse(localStorage.getItem('ffUsers')) || {};
            const usersTable = document.getElementById('usersTable');
            
            usersTable.innerHTML = '';
            
            let totalUsers = 0;
            
            for (const username in users) {
                totalUsers++;
                const user = users[username];
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td style="padding: 15px; border-bottom: 1px solid #333;">${username}</td>
                    <td style="padding: 15px; border-bottom: 1px solid #333;">${user.playerId || 'N/A'}</td>
                    <td style="padding: 15px; border-bottom: 1px solid #333;">${user.phone || 'N/A'}</td>
                    <td style="padding: 15px; border-bottom: 1px solid #333;">
                        PKR ${user.balance || 0}
                        <button onclick="editBalance('${username}', ${user.balance || 0})" 
                                style="background: #00f0ff; color: black; border: none; padding: 5px 10px; border-radius: 3px; margin-left: 10px; cursor: pointer;">
                            Edit
                        </button>
                    </td>
                    <td style="padding: 15px; border-bottom: 1px solid #333;">
                        <span style="color: ${user.status === 'active' ? '#00ff88' : '#ff4655'}; font-weight: bold;">
                            ${user.status || 'active'}
                        </span>
                    </td>
                    <td style="padding: 15px; border-bottom: 1px solid #333;">
                        <button onclick="toggleUserStatus('${username}', '${user.status || 'active'}')" 
                                style="background: ${(user.status || 'active') === 'active' ? '#ff4655' : '#00ff88'}; color: ${(user.status || 'active') === 'active' ? 'white' : 'black'}; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer;">
                            ${(user.status || 'active') === 'active' ? 'Block' : 'Unblock'}
                        </button>
                    </td>
                `;
                usersTable.appendChild(row);
            }
            
            document.getElementById('totalUsers').textContent = totalUsers;
        }

        // ====== TOURNAMENT FORM ======
        document.getElementById('tournamentForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const name = document.getElementById('tournamentName').value;
            const entryFee = document.getElementById('entryFee').value;
            const prizePool = document.getElementById('prizePool').value;
            const maxPlayers = document.getElementById('maxPlayers').value;
            const desc = document.getElementById('tournamentDesc').value;
            
            if (!name || !entryFee || !prizePool || !maxPlayers) {
                showMessage('Please fill all required fields', 'error');
                return;
            }
            
            const tournaments = JSON.parse(localStorage.getItem('tournaments')) || [];
            tournaments.push({
                name: name,
                entryFee: entryFee,
                prizePool: prizePool,
                maxPlayers: maxPlayers,
                description: desc,
                createdAt: new Date().toISOString(),
                status: 'active'
            });
            
            localStorage.setItem('tournaments', JSON.stringify(tournaments));
            
            showMessage('Tournament created successfully!', 'success');
            this.reset();
            loadTournaments();
        });

        // ====== APPROVE DEPOSIT FUNCTION - FIXED FOR FIREBASE ======
        async function approveDeposit(depositId, username, amount, isFirebase) {
            if (!confirm(`âœ… APPROVE DEPOSIT\n\nUser: ${username}\nAmount: PKR ${amount}\n\nThis will add PKR ${amount} to user's wallet.`)) return;
            
            try {
                // Update in Firebase
                if (isFirebase && db) {
                    await db.collection('deposits').doc(depositId).update({
                        status: 'approved',
                        approvedAt: new Date().toISOString(),
                        approvedBy: 'admin'
                    });
                }
                
                // Update in local storage
                let localDeposits = JSON.parse(localStorage.getItem('depositRequests')) || [];
                localDeposits = localDeposits.map(deposit => {
                    if (deposit.id === depositId || deposit.firebaseId === depositId) {
                        deposit.status = 'approved';
                        deposit.approvedAt = new Date().toISOString();
                        deposit.approvedBy = 'admin';
                    }
                    return deposit;
                });
                localStorage.setItem('depositRequests', JSON.stringify(localDeposits));
                
                // ====== ADD MONEY TO USER'S WALLET ======
                let users = JSON.parse(localStorage.getItem('ffUsers')) || {};
                
                // Create user if doesn't exist
                if (!users[username]) {
                    users[username] = {
                        playerId: 'N/A',
                        phone: 'N/A',
                        balance: 0,
                        status: 'active',
                        createdAt: new Date().toISOString()
                    };
                }
                
                // Get current balance
                const currentBalance = parseFloat(users[username].balance) || 0;
                const depositAmount = parseFloat(amount);
                
                // Add money to user's wallet
                users[username].balance = currentBalance + depositAmount;
                users[username].lastDeposit = new Date().toISOString();
                
                // Save updated users
                localStorage.setItem('ffUsers', JSON.stringify(users));
                
                // Update statistics
                document.getElementById('pendingDeposits').textContent = localDeposits.filter(d => d.status === 'pending').length;
                document.getElementById('totalUsers').textContent = Object.keys(users).length;
                
                showMessage(`âœ… Deposit Approved!\n\n${username} received PKR ${depositAmount}\nNew Balance: PKR ${users[username].balance}`, 'success');
                
                // Auto-delete the request after 1.5 seconds
                setTimeout(() => {
                    autoDeleteDepositRequest(depositId, isFirebase);
                }, 1500);
                
                // Refresh displays
                setTimeout(() => {
                    loadDepositRequests();
                    loadUsers();
                }, 1000);
                
            } catch (error) {
                console.error('Approval error:', error);
                showMessage('âŒ Error approving deposit', 'error');
            }
        }

        async function rejectDeposit(depositId, isFirebase) {
            if (!confirm('âŒ REJECT DEPOSIT\n\nThis deposit request will be rejected.')) return;
            
            try {
                if (isFirebase && db) {
                    await db.collection('deposits').doc(depositId).update({
                        status: 'rejected',
                        rejectedAt: new Date().toISOString()
                    });
                }
                
                let localDeposits = JSON.parse(localStorage.getItem('depositRequests')) || [];
                localDeposits = localDeposits.map(deposit => {
                    if (deposit.id === depositId || deposit.firebaseId === depositId) {
                        deposit.status = 'rejected';
                        deposit.rejectedAt = new Date().toISOString();
                    }
                    return deposit;
                });
                localStorage.setItem('depositRequests', JSON.stringify(localDeposits));
                
                document.getElementById('pendingDeposits').textContent = localDeposits.filter(d => d.status === 'pending').length;
                
                showMessage('âŒ Deposit request rejected', 'success');
                
                // Auto-delete the request after 1.5 seconds
                setTimeout(() => {
                    autoDeleteDepositRequest(depositId, isFirebase);
                }, 1500);
                
                setTimeout(loadDepositRequests, 1000);
                
            } catch (error) {
                console.error('Rejection error:', error);
                showMessage('Error rejecting deposit', 'error');
            }
        }

        async function approveWithdrawal(withdrawalId, isFirebase) {
            if (!confirm('Approve this withdrawal request?')) return;
            
            try {
                if (isFirebase && db) {
                    await db.collection('withdrawals').doc(withdrawalId).update({
                        status: 'approved',
                        approvedAt: new Date().toISOString()
                    });
                }
                
                let localWithdrawals = JSON.parse(localStorage.getItem('withdrawalRequests')) || [];
                localWithdrawals = localWithdrawals.map(withdrawal => {
                    if (withdrawal.id === withdrawalId || withdrawal.firebaseId === withdrawalId) {
                        withdrawal.status = 'approved';
                    }
                    return withdrawal;
                });
                localStorage.setItem('withdrawalRequests', JSON.stringify(localWithdrawals));
                
                showMessage('Withdrawal request approved', 'success');
                
                // Auto-delete the request after 1.5 seconds
                setTimeout(() => {
                    autoDeleteWithdrawalRequest(withdrawalId, isFirebase);
                }, 1500);
                
                setTimeout(loadWithdrawalRequests, 1000);
                
            } catch (error) {
                console.error('Approval error:', error);
                showMessage('Error approving withdrawal', 'error');
            }
        }

        async function rejectWithdrawal(withdrawalId, isFirebase) {
            if (!confirm('Reject this withdrawal request?')) return;
            
            try {
                if (isFirebase && db) {
                    await db.collection('withdrawals').doc(withdrawalId).update({
                        status: 'rejected',
                        rejectedAt: new Date().toISOString()
                    });
                }
                
                let localWithdrawals = JSON.parse(localStorage.getItem('withdrawalRequests')) || [];
                localWithdrawals = localWithdrawals.map(withdrawal => {
                    if (withdrawal.id === withdrawalId || withdrawal.firebaseId === withdrawalId) {
                        withdrawal.status = 'rejected';
                    }
                    return withdrawal;
                });
                localStorage.setItem('withdrawalRequests', JSON.stringify(localWithdrawals));
                
                showMessage('Withdrawal request rejected', 'success');
                
                // Auto-delete the request after 1.5 seconds
                setTimeout(() => {
                    autoDeleteWithdrawalRequest(withdrawalId, isFirebase);
                }, 1500);
                
                // Auto-refund to user wallet
                setTimeout(() => {
                    autoRefundWithdrawal(withdrawalId, isFirebase);
                }, 1000);
                
                setTimeout(loadWithdrawalRequests, 1000);
                
            } catch (error) {
                console.error('Rejection error:', error);
                showMessage('Error rejecting withdrawal', 'error');
            }
        }

        // ====== USER MANAGEMENT FUNCTIONS ======
        function toggleUserStatus(username, currentStatus) {
            let users = JSON.parse(localStorage.getItem('ffUsers')) || {};
            
            if (users[username]) {
                users[username].status = currentStatus === 'active' ? 'inactive' : 'active';
                localStorage.setItem('ffUsers', JSON.stringify(users));
                
                showMessage(`User ${username} ${currentStatus === 'active' ? 'blocked' : 'unblocked'}`, 'success');
                loadUsers();
            }
        }

        function editBalance(username, currentBalance) {
            const newBalance = prompt(`Edit balance for ${username}\nCurrent: PKR ${currentBalance}\n\nEnter new balance:`, currentBalance);
            
            if (newBalance !== null && !isNaN(newBalance)) {
                let users = JSON.parse(localStorage.getItem('ffUsers')) || {};
                
                if (users[username]) {
                    users[username].balance = parseFloat(newBalance);
                    localStorage.setItem('ffUsers', JSON.stringify(users));
                    
                    showMessage(`Balance updated for ${username}`, 'success');
                    loadUsers();
                }
            }
        }

        // ====== TOURNAMENT MANAGEMENT FUNCTIONS ======
        function editTournament(index) {
            const tournaments = JSON.parse(localStorage.getItem('tournaments')) || [];
            const tournament = tournaments[index];
            
            document.getElementById('tournamentName').value = tournament.name;
            document.getElementById('entryFee').value = tournament.entryFee;
            document.getElementById('prizePool').value = tournament.prizePool;
            document.getElementById('maxPlayers').value = tournament.maxPlayers;
            document.getElementById('tournamentDesc').value = tournament.description || '';
            
            tournaments.splice(index, 1);
            localStorage.setItem('tournaments', JSON.stringify(tournaments));
            
            showMessage('Tournament loaded for editing. Make changes and click Create.', 'success');
            loadTournaments();
        }

        function deleteTournament(index) {
            if (!confirm('Are you sure you want to delete this tournament?')) return;
            
            const tournaments = JSON.parse(localStorage.getItem('tournaments')) || [];
            tournaments.splice(index, 1);
            localStorage.setItem('tournaments', JSON.stringify(tournaments));
            
            showMessage('Tournament deleted successfully!', 'success');
            loadTournaments();
        }

        function viewTournamentPlayers(index) {
            showMessage('Feature coming soon! This will show all registered players for this tournament.', 'success');
        }

        // ====== ADMIN SETTINGS FUNCTIONS ======
        function changePassword() {
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            if (!currentPassword || !newPassword || !confirmPassword) {
                showMessage('Please fill all fields', 'error');
                return;
            }
            
            if (newPassword !== confirmPassword) {
                showMessage('New passwords do not match', 'error');
                return;
            }
            
            showMessage('Password updated successfully!', 'success');
            
            document.getElementById('currentPassword').value = '';
            document.getElementById('newPassword').value = '';
            document.getElementById('confirmPassword').value = '';
        }

        function exportDatabase() {
            const data = {
                users: JSON.parse(localStorage.getItem('ffUsers')) || {},
                deposits: JSON.parse(localStorage.getItem('depositRequests')) || [],
                withdrawals: JSON.parse(localStorage.getItem('withdrawalRequests')) || [],
                tournaments: JSON.parse(localStorage.getItem('tournaments')) || [],
                exportDate: new Date().toISOString()
            };
            
            const dataStr = JSON.stringify(data, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            
            const exportFileDefaultName = 'ff_tournament_backup.json';
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
            
            showMessage('Database exported successfully!', 'success');
        }

        function importDatabase() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            
            input.onchange = function(e) {
                const file = e.target.files[0];
                const reader = new FileReader();
                
                reader.onload = function(event) {
                    try {
                        const data = JSON.parse(event.target.result);
                        
                        if (data.users) localStorage.setItem('ffUsers', JSON.stringify(data.users));
                        if (data.deposits) localStorage.setItem('depositRequests', JSON.stringify(data.deposits));
                        if (data.withdrawals) localStorage.setItem('withdrawalRequests', JSON.stringify(data.withdrawals));
                        if (data.tournaments) localStorage.setItem('tournaments', JSON.stringify(data.tournaments));
                        
                        showMessage('Database imported successfully!', 'success');
                        loadUsers();
                        loadDepositRequests();
                        loadWithdrawalRequests();
                        loadTournaments();
                        
                    } catch (error) {
                        showMessage('Error importing database: Invalid file format', 'error');
                    }
                };
                
                reader.readAsText(file);
            };
            
            input.click();
        }

        function clearDatabase() {
            if (!confirm('âš ï¸ WARNING: This will delete ALL data including users, deposits, withdrawals and tournaments. Are you sure?')) return;
            
            localStorage.clear();
            localStorage.setItem('adminLoggedIn', 'true');
            
            showMessage('All data cleared successfully!', 'success');
            setTimeout(() => {
                window.location.reload();
            }, 2000);
        }

        // ====== UTILITY FUNCTIONS ======
        function viewScreenshot(imageSrc) {
            document.getElementById('fullScreenshot').src = imageSrc;
            document.getElementById('screenshotModal').style.display = 'flex';
        }

        function closeScreenshot() {
            document.getElementById('screenshotModal').style.display = 'none';
        }

        function showMessage(text, type) {
            const messageDiv = document.getElementById('message');
            messageDiv.textContent = text;
            messageDiv.className = `message ${type}`;
            
            setTimeout(() => {
                messageDiv.style.display = 'none';
            }, 3000);
        }
        
        // ==================== AUTO FEATURES ====================
        
        // 1. Auto-delete deposit request
        function autoDeleteDepositRequest(depositId, isFirebase) {
            console.log('Auto-delete: Deleting deposit:', depositId, 'isFirebase:', isFirebase);
            
            try {
                // Remove from localStorage
                let deposits = JSON.parse(localStorage.getItem('depositRequests')) || [];
                let found = false;
                
                deposits = deposits.filter(d => {
                    // FIX: Check both ID and firebaseId
                    const idMatch = d.id == depositId || d.firebaseId == depositId;
                    if (idMatch) found = true;
                    return !idMatch;
                });
                
                if (found) {
                    localStorage.setItem('depositRequests', JSON.stringify(deposits));
                    console.log('Deleted from localStorage');
                }
                
                // Remove from Firebase
                if (isFirebase && firebaseConnected && db) {
                    db.collection('deposits').doc(depositId).delete()
                        .then(() => console.log('Deleted from Firebase'))
                        .catch(err => console.log('Firebase error:', err));
                }
                
                // Update UI
                setTimeout(() => {
                    loadDepositRequests();
                    showAutoNotification('âœ… Deposit request auto-deleted');
                }, 500);
                
            } catch (error) {
                console.error('Auto-delete error:', error);
            }
        }
        
        // 2. Auto-delete withdrawal request
        function autoDeleteWithdrawalRequest(withdrawalId, isFirebase) {
            console.log('Auto-delete: Deleting withdrawal:', withdrawalId, 'isFirebase:', isFirebase);
            
            try {
                // Remove from localStorage
                let withdrawals = JSON.parse(localStorage.getItem('withdrawalRequests')) || [];
                let found = false;
                
                withdrawals = withdrawals.filter(w => {
                    // FIX: Check both ID and firebaseId
                    const idMatch = w.id == withdrawalId || w.firebaseId == withdrawalId;
                    if (idMatch) found = true;
                    return !idMatch;
                });
                
                if (found) {
                    localStorage.setItem('withdrawalRequests', JSON.stringify(withdrawals));
                    console.log('Deleted from localStorage');
                }
                
                // Remove from Firebase
                if (isFirebase && firebaseConnected && db) {
                    db.collection('withdrawals').doc(withdrawalId).delete()
                        .then(() => console.log('Deleted from Firebase'))
                        .catch(err => console.log('Firebase error:', err));
                }
                
                // Update UI
                setTimeout(() => {
                    loadWithdrawalRequests();
                    showAutoNotification('âœ… Withdrawal request auto-deleted');
                }, 500);
                
            } catch (error) {
                console.error('Auto-delete error:', error);
            }
        }
        
        // 3. Auto-refund withdrawal
        function autoRefundWithdrawal(withdrawalId, isFirebase) {
            console.log('Auto-refund: Processing withdrawal refund:', withdrawalId);
            
            // Get withdrawal details
            getWithdrawalDetailsForRefund(withdrawalId, isFirebase)
                .then(withdrawalDetails => {
                    if (!withdrawalDetails) {
                        console.log('No withdrawal details found');
                        return;
                    }
                    
                    const { username, amount } = withdrawalDetails;
                    console.log(`Auto-refund: Refunding PKR ${amount} to ${username}`);
                    
                    // Refund to user wallet
                    refundToUserWalletAuto(withdrawalDetails);
                })
                .catch(error => {
                    console.error('Auto-refund error:', error);
                });
        }
        
        // Get withdrawal details for refund
        async function getWithdrawalDetailsForRefund(withdrawalId, isFirebase) {
            try {
                if (isFirebase && firebaseConnected && db) {
                    const doc = await db.collection('withdrawals').doc(withdrawalId).get();
                    if (doc.exists) {
                        const data = doc.data();
                        return {
                            id: withdrawalId,
                            username: data.username,
                            amount: data.amount,
                            isFirebase: true
                        };
                    }
                }
                
                const withdrawals = JSON.parse(localStorage.getItem('withdrawalRequests')) || [];
                const withdrawal = withdrawals.find(w => w.id == withdrawalId || w.firebaseId == withdrawalId);
                
                if (withdrawal) {
                    return {
                        id: withdrawalId,
                        username: withdrawal.username,
                        amount: withdrawal.amount,
                        isFirebase: false
                    };
                }
                
                return null;
            } catch (error) {
                console.error('Error getting withdrawal details:', error);
                return null;
            }
        }
        
        // Refund to user wallet
        function refundToUserWalletAuto(withdrawalDetails) {
            if (!withdrawalDetails || !withdrawalDetails.username || !withdrawalDetails.amount) {
                console.log('Auto-refund: No withdrawal details found');
                return;
            }
            
            const { username, amount } = withdrawalDetails;
            
            try {
                let users = JSON.parse(localStorage.getItem('ffUsers')) || {};
                
                // Create user if doesn't exist
                if (!users[username]) {
                    users[username] = {
                        playerId: 'N/A',
                        phone: 'N/A',
                        balance: 0,
                        status: 'active',
                        createdAt: new Date().toISOString()
                    };
                }
                
                // Add money back to user's wallet
                const currentBalance = parseFloat(users[username].balance) || 0;
                const refundAmount = parseFloat(amount);
                users[username].balance = currentBalance + refundAmount;
                
                // Save updated users
                localStorage.setItem('ffUsers', JSON.stringify(users));
                
                // Show notification
                showAutoNotification(`âœ… Auto-refund: PKR ${refundAmount} returned to ${username}'s wallet`);
                
                console.log(`Auto-refund: Success! ${username}'s new balance: PKR ${users[username].balance}`);
                
                // Update user display if user tab is open
                setTimeout(() => {
                    if (document.querySelector('#usersTab.active')) {
                        loadUsers();
                    }
                }, 1000);
                
            } catch (error) {
                console.error('Auto-refund error:', error);
                showAutoNotification('âŒ Error processing auto-refund', true);
            }
        }
        
        // Show auto feature notification
        function showAutoNotification(message, isError = false) {
            // Check if notification already exists
            const existingNotification = document.querySelector('.auto-notification');
            if (existingNotification) {
                existingNotification.remove();
            }
            
            const notification = document.createElement('div');
            notification.className = `auto-notification ${isError ? 'error' : ''}`;
            notification.style.cssText = `
                position: fixed;
                top: 80px;
                right: 20px;
                background: ${isError ? '#ff4655' : '#00ff88'};
                color: ${isError ? 'white' : 'black'};
                padding: 15px 25px;
                border-radius: 10px;
                z-index: 10000;
                font-weight: bold;
                box-shadow: 0 5px 15px rgba(0,0,0,0.3);
                display: flex;
                align-items: center;
                gap: 10px;
                animation: slideInRight 0.3s ease;
                max-width: 400px;
            `;
            
            notification.innerHTML = `
                <i class="fas fa-${isError ? 'exclamation-circle' : 'check-circle'}"></i>
                <span>${message}</span>
                <button onclick="this.parentElement.remove()" style="
                    background: transparent;
                    border: none;
                    font-size: 20px;
                    cursor: pointer;
                    margin-left: 15px;
                    color: inherit;
                ">Ã—</button>
            `;
            
            document.body.appendChild(notification);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.style.animation = 'slideOutRight 0.3s ease';
                    setTimeout(() => notification.remove(), 300);
                }
            }, 5000);
        }
        
        console.log('âœ… All auto-features loaded!');
        console.log('1. Auto-add money to wallet + delete on deposit approval');
        console.log('2. Auto-refund + delete on withdrawal rejection');
        console.log('3. Auto-delete on deposit rejection');
        console.log('4. Auto-delete on withdrawal approval');
        console.log('ðŸ”¥ Firebase buttons now working!');
        // ==================== END OF AUTO FEATURES ====================
    </script>
</body>
</html>